# explaining-malware
Explaining Malware Behaviours using Graphs - NUS B. Comp. Dissertation Project

## Setting up
The programs (outside Python) used in this project are as follows:
- `IDA Pro v7.6`
- `graphviz`

The Python dependencies can be found in `requirements.txt`.

The steps to install IDA can be found at Hex Rays' website. 
> Note: This code uses paramiko to connect to a remote SSH server. More details under WORKFLOW section.

To install `graphviz`, run:
```bash
sudo apt install graphviz
```
It is recommended to create a virtual environment before installing the dependencies. To automatically install the (Python) dependencies, run:
```bash
setup.sh
```

## Directory Structure
The directory structure of this project is as follows:
```bash
.
├── inputs
│   └── MALWARE_NAME
├── outputs
│   └── MALWARE_NAME
│       ├── simplified.dot
│       ├── simplified.svg
│       ├── cfg.dot
│       └── metadata.json
├── README.md
├── requirements.txt
├── setup.sh
└── src
    ├── behavior_graph_gen.py
    ├── capa
    ├── capability.py
    ├── capa_parser.py
    ├── cfg_generator.py
    ├── extract_bfg.py
    ├── ida_cfg_gen.py
    └── run_all.sh
```
Explanation:
- The malware samples (PE/ELF) are located in the `inputs` directory
- The scripts used to generate the behavior graph are located in the `src` directory
- After running the script, the behavior graph is located in the `outputs/{MALWARE_NAME}/simplified.svg`
  - Inside the `outputs/{MALWARE_NAME}` directory, the intermediate outputs generated in the process are preserved.
  - `cfg.dot` : control flow graph of the malware in DOT format
  - `metadata.json` : contains information about the starting address and ending address of each basic block in the cfg.

## Running the program
Before running the program, put the malware samples in the `inputs/` directory. Then, go to the `src/` directory and simply type:
> :warning: **IMPORTANT!** The script must be invoked from the `src/` directory. The current version of this project does not handle the path properly.
```bash
./run_all.sh
```

## Workflow
When we run `./run_all.sh`, the `extract_bfg.py` script is called with the appropriate parameters. 
- `extract_bfg.py` will call `cfg_generator.py`, which is a module to obtain control flow graph from the input binary. 
- `cfg_generator.py` will send two things: the input binary and `ida_cfg_gen.py` script to the remote IDA server. On the remote server, the `ida_cfg_gen.py` script will be run by the IDA decompiler and it will produce two files: `cfg.dot` and `metadata.json`. `cfg.dot` is the control flow graph generated by IDA in DOT format, while `metadata.json` contains the starting address and the ending address for each basic block in the control flow graph. This information is required to figure out the exact block that contains the instruction marked by capa.
- `ida_cfg_gen.py` will fetch the two files back to the host. In the current `run.sh` file, the output directory is specified to be `outputs/{MALWARE_NAME}`. Using these two files, `behavior_graph_gen.py` will construct the behavior graph.

Inside `behavior_graph_gen.py`, the behavior graph construction is as follows:
- Annotate each basic block (whether it contains capability or not, give appropriate label, etc.)
- Remove all basic blocks which do not contain any capability nor jump instructions and connect all predecessors to all successors of that block.

