#/usr/bin/python3

import subprocess
import sys

USERNAME = "adhy"
HOST = "flood"
REMOTE_DIR = "/tmp/cfg_generator/"
IDA_PATH = "/opt/idapro/ida"

def run_command(command):
  print("command run: ", end="")
  print(f"ssh {USERNAME}@{HOST} '{command}'")
  return subprocess.run(f"ssh {USERNAME}@{HOST} '{command}'", shell=True)

def copy_to_remote(file_path):
  print("command run: ", end="")
  print(f"scp {file_path} {USERNAME}@{HOST}:{REMOTE_DIR}")
  return subprocess.run(f"scp {file_path} {USERNAME}@{HOST}:{REMOTE_DIR}", shell=True)

def fetch_from_remote(file_path, output_dir):
  print("command run: ", end="")
  print(f"scp {USERNAME}@{HOST}:{REMOTE_DIR}{file_path} {output_dir}")
  return subprocess.run(f"scp {USERNAME}@{HOST}:{REMOTE_DIR}{file_path} {output_dir}", shell=True)

def main():
  ## If the output folder exists, skip analysing the malware
  dir_exists = run_command(f"test -e {REMOTE_DIR}")
  if dir_exists.returncode == 0:
    print(f"Remote directory exists {REMOTE_DIR} exists. Remove all files inside? (y/N)")
    if (input().lower() != 'y'):
      return 
    run_command(f"rm -rf {REMOTE_DIR}*")
  else:
    run_command(f"mkdir -p {REMOTE_DIR}")

  # copy over sample and script to remote
  malware_path = sys.argv[1]
  name_idx = malware_path.rfind("/")
  malware_name = malware_path[name_idx+1:]
  copy_to_remote("./ida_cfg_gen.py")
  copy_to_remote(f"{malware_path}")

  # Generate CFG using IDA
  run_command(f"{IDA_PATH} -A -S\"{REMOTE_DIR}ida_cfg_gen.py {REMOTE_DIR}\" {REMOTE_DIR}{malware_name}")

  output_dir = sys.argv[2]

  # fetch results
  fetch_from_remote("cfg.dot", output_dir)
  fetch_from_remote("metadata.json", output_dir)

  # Cleanup
  run_command(f"rm -rf {REMOTE_DIR}")
    
if __name__ == "__main__":
    main()
