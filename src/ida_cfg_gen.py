import ida_gdl
import ida_auto
import ida_pro
import idc
import json

MALWARE_DIR = "../inputs/"
OUTPUT_DIR = "../outputs/"

def generate_global_cfg():
    malware_sample = idc.ARGV[1]
    # ida_gdl.gen_flow_graph is called in the background
    idc.gen_flow_graph(OUTPUT_DIR + malware_sample + ".dot", "cfg", 0, idc.BADADDR, ida_gdl.CHART_GEN_DOT)

    # generate basic block metadata (start_ea, end_ea) which is lost during creation of flow graph
    flow_c = ida_gdl.FlowChart(None, (0, idc.BADADDR))
    metadata = dict() # {id : {start_ea: xxx, end_ea: xxx}}
    for block in flow_c:
        metadata[block.id] = {"start_ea": block.start_ea, "end_ea": block.end_ea}
    with open(OUTPUT_DIR + malware-sample + "-meta.json", "w") as f:
        json.dump(metadata, f)

def main():
    ida_auto.auto_wait()
    generate_global_cfg()
    ida_pro.qexit(0)
    
if __name__ == "__main__":
    main()
